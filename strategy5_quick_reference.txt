â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   STRATEGY 5 ANALYSIS - QUICK REFERENCE                  â”‚
â”‚                          One-Page Decision Guide                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€ VERDICT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âŒ DO NOT IMPLEMENT STRATEGY 5                                         â”‚
â”‚  âœ… USE PHASE 1 IMMEDIATE FIX INSTEAD                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€ WHY STRATEGY 5 IS WRONG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                          â”‚
â”‚  1. DYNAMIC CAP: mean(denom) is mathematically incorrect                â”‚
â”‚     â€¢ denom shape is [B,1,1,1] (already spatially pooled)              â”‚
â”‚     â€¢ mean(dim=[1,2,3]) is a no-op or introduces batch dependency      â”‚
â”‚     â€¢ Legacy Mode B already does adaptive capping (line 1396)           â”‚
â”‚     â†’ REDUNDANT, already implemented                                    â”‚
â”‚                                                                          â”‚
â”‚  2. KL DIVERGENCE: Not applicable to residuals                          â”‚
â”‚     â€¢ Residuals are NOT probability distributions                       â”‚
â”‚     â€¢ softmax(delta_log) loses sign information (neg â†’ pos)            â”‚
â”‚     â€¢ Spatial flattening destroys structure                             â”‚
â”‚     â€¢ No academic precedent (VQGAN, RAFT don't use this)               â”‚
â”‚     â†’ MATHEMATICALLY INCORRECT                                          â”‚
â”‚                                                                          â”‚
â”‚  3. DOESN'T SOLVE OVERFLOW: Root cause is absolute magnitude            â”‚
â”‚     â€¢ High-contrast patches still have large denom (e.g., 16.0)        â”‚
â”‚     â€¢ Dynamic cap = denom * 0.9 = 14.4 â†’ still overflow                â”‚
â”‚     â€¢ Need absolute limit, not relative scaling                         â”‚
â”‚     â†’ INEFFECTIVE                                                       â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€ WHAT TO DO INSTEAD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                          â”‚
â”‚  PHASE 1 (5 minutes, 80% problem solved):                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ File: configs/colleague_training_config.yaml                     â”‚  â”‚
â”‚  â”‚   log_delta_abs_max: 6.0   # was 16.0                            â”‚  â”‚
â”‚  â”‚   log_delta_alpha: 1.0      # was 1.2                            â”‚  â”‚
â”‚  â”‚   log_supervision_weight: 2.0  # was 1.0                         â”‚  â”‚
â”‚  â”‚   log_supervision_type: huber  # was l1                          â”‚  â”‚
â”‚  â”‚                                                                   â”‚  â”‚
â”‚  â”‚ File: train/patch_training_framework.py (line 1393)              â”‚  â”‚
â”‚  â”‚   delta_log = ... # existing code                                â”‚  â”‚
â”‚  â”‚   delta_log = torch.clamp(delta_log, min=-8.0, max=8.0)  # ADD  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                          â”‚
â”‚  PHASE 2 (2 hours, removes hyperparameter tuning):                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ File: src/npu/networks/patch/patch_network.py                    â”‚  â”‚
â”‚  â”‚   class PatchNetwork:                                             â”‚  â”‚
â”‚  â”‚       def __init__(...):                                          â”‚  â”‚
â”‚  â”‚           self.residual_output_scale = nn.Parameter(              â”‚  â”‚
â”‚  â”‚               torch.tensor([6.0])                                 â”‚  â”‚
â”‚  â”‚           )                                                        â”‚  â”‚
â”‚  â”‚       def forward(self, x, ...):                                  â”‚  â”‚
â”‚  â”‚           residual = torch.tanh(x5) * self.residual_output_scale â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€ KEY TECHNICAL INSIGHTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                          â”‚
â”‚  Current Implementation (log normalization):                            â”‚
â”‚    1. log_img = log(warped_rgb + eps)                                  â”‚
â”‚    2. denom = max(log_img) - min(log_img)  â† Per-patch dynamic range  â”‚
â”‚    3. Xn = (log_img - min_log) / denom     â† Normalize to [0,1]       â”‚
â”‚    4. residual_pred = Network(Xn)          â† Tanh output [-1,1]       â”‚
â”‚    5. delta_log = scale * residual_pred * cap                          â”‚
â”‚    6. output = exp(log_img + delta_log) - eps                          â”‚
â”‚                                                                          â”‚
â”‚  Problem with Current Settings:                                         â”‚
â”‚    cap = log_delta_alpha * log_delta_abs_max = 1.2 * 16.0 = 19.2      â”‚
â”‚    exp(19.2) = 218,407,808  â† OVERFLOW (218 million!)                 â”‚
â”‚                                                                          â”‚
â”‚  Solution (Phase 1):                                                    â”‚
â”‚    cap = 1.0 * 6.0 = 6.0                                               â”‚
â”‚    exp(6.0) = 403           â† SAFE (within HDR range)                 â”‚
â”‚    Hard clamp at Â±8.0 as failsafe: exp(8.0) = 2981                    â”‚
â”‚                                                                          â”‚
â”‚  Why tanh?                                                              â”‚
â”‚    â€¢ Bounds network output to [-1,1]                                   â”‚
â”‚    â€¢ Soft clamping (smooth gradients near boundaries)                  â”‚
â”‚    â€¢ Prevents exploding gradients in log space                         â”‚
â”‚                                                                          â”‚
â”‚  Why denom is NOT suitable for dynamic cap:                            â”‚
â”‚    â€¢ High-contrast patch: denom = 16.0 â†’ still too large              â”‚
â”‚    â€¢ Low-contrast patch: denom = 2.0 â†’ may be too restrictive         â”‚
â”‚    â€¢ Batch variance: CV ~30-50% (unstable across batches)             â”‚
â”‚    â€¢ Already used for input normalization (don't double-apply)         â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€ COMPARISON TABLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                          â”‚
â”‚  Metric            â”‚ Strategy 5  â”‚ Phase 1 Fix â”‚ Phase 2 Learnable    â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  Implementation    â”‚ 4 hours     â”‚ 5 minutes   â”‚ 2 hours              â”‚
â”‚  Risk              â”‚ High        â”‚ Low         â”‚ Medium               â”‚
â”‚  Solves overflow   â”‚ âŒ No       â”‚ âœ… Yes      â”‚ âœ… Yes               â”‚
â”‚  Math soundness    â”‚ âŒ Wrong    â”‚ âœ… Correct  â”‚ âœ… Correct           â”‚
â”‚  Hyperparams       â”‚ +3 new      â”‚ -1 (simpler)â”‚ 0 (learnable)        â”‚
â”‚  Expected gain     â”‚ 0%          â”‚ 15-20%      â”‚ 20-30%               â”‚
â”‚  Precedent         â”‚ âŒ None     â”‚ âœ… Common   â”‚ âœ… ResNets, EDSR     â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€ FILES TO READ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                          â”‚
â”‚  ğŸ“„ Full Analysis (50 pages):                                           â”‚
â”‚     /home/kyrie/mobileExtra/analysis_strategy5_log_residual_constraints.md
â”‚                                                                          â”‚
â”‚  ğŸ“‹ Executive Summary (5 pages):                                        â”‚
â”‚     /home/kyrie/mobileExtra/strategy5_verdict_summary.txt              â”‚
â”‚                                                                          â”‚
â”‚  ğŸ”§ Ready-to-Apply Patch:                                               â”‚
â”‚     /home/kyrie/mobileExtra/PHASE1_IMMEDIATE_FIX.patch                 â”‚
â”‚                                                                          â”‚
â”‚  ğŸ“Œ This Quick Reference:                                               â”‚
â”‚     /home/kyrie/mobileExtra/strategy5_quick_reference.txt              â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€ CHECKLIST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                          â”‚
â”‚  Before Proceeding:                                                     â”‚
â”‚    [ ] Read full analysis document (sections 2.2, 3.2, 5.1)            â”‚
â”‚    [ ] Understand why KL divergence is wrong for residuals             â”‚
â”‚    [ ] Understand why dynamic cap is redundant (Mode B exists)         â”‚
â”‚    [ ] Agree to abandon Strategy 5 implementation                      â”‚
â”‚                                                                          â”‚
â”‚  To Apply Phase 1:                                                      â”‚
â”‚    [ ] Backup current config file                                      â”‚
â”‚    [ ] Edit colleague_training_config.yaml (4 lines)                   â”‚
â”‚    [ ] Edit patch_training_framework.py (2 clamp statements)           â”‚
â”‚    [ ] Run 1 test epoch to verify no overflow                          â”‚
â”‚    [ ] Monitor delta_log range (should be within Â±8.0)                 â”‚
â”‚    [ ] If successful, continue full training                           â”‚
â”‚                                                                          â”‚
â”‚  After Phase 1 Success:                                                 â”‚
â”‚    [ ] Validate val_loss is stable or improved                         â”‚
â”‚    [ ] Check SSIM metrics (should be stable)                           â”‚
â”‚    [ ] Inspect visualizations (less bloom/overflow)                    â”‚
â”‚    [ ] Proceed to Phase 2 (learnable scale) for further gains          â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€ KEY TAKEAWAYS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                          â”‚
â”‚  1. âŒ Don't implement Strategy 5 (dynamic cap + KL divergence)         â”‚
â”‚     Reasons: Redundant, mathematically incorrect, doesn't solve issue  â”‚
â”‚                                                                          â”‚
â”‚  2. âœ… DO implement Phase 1 (reduce cap from 16.0 â†’ 6.0)               â”‚
â”‚     Impact: 80-95% overflow reduction, 5 minutes, zero risk            â”‚
â”‚                                                                          â”‚
â”‚  3. âœ… DO implement Phase 2 (learnable scale) after validating Phase 1  â”‚
â”‚     Impact: Removes hyperparameter tuning, 5-10% val_loss gain         â”‚
â”‚                                                                          â”‚
â”‚  4. ğŸ”¬ Residuals are not distributions â†’ don't use KL divergence        â”‚
â”‚     Alternatives: L1, Huber, perceptual, histogram matching            â”‚
â”‚                                                                          â”‚
â”‚  5. ğŸ“Š Log-space HDR: Great for perceptual uniformity, but needs care  â”‚
â”‚     Key: Bound residuals to prevent exp() overflow (Â±6-8 is safe)     â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€ CONTACT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                          â”‚
â”‚  Questions? Re-read these sections in full analysis:                   â”‚
â”‚    â€¢ Section 2.2: Why dynamic cap is mathematically wrong              â”‚
â”‚    â€¢ Section 3.2: Why KL divergence doesn't apply to residuals         â”‚
â”‚    â€¢ Section 5.1: Learnable scale parameters (recommended)             â”‚
â”‚    â€¢ Appendix A: Copy-paste code snippets                              â”‚
â”‚                                                                          â”‚
â”‚  This analysis by: Claude Sonnet 4.5 (Backend System Architect)        â”‚
â”‚  Date: 2025-10-21                                                       â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
